# GD32项目框架技能包

## 项目概述

这是一个基于GD32/STM32F429的完整嵌入式开发框架，包含了外设驱动、任务调度器、UI系统、通信协议等多个模块，为嵌入式开发提供了统一的解决方案。

## 框架架构

### 1. 硬件��象层 (HAL)
- **基础驱动**: GPIO, USART, ADC, DAC, DMA, SPI, I2C, SDIO, TIM
- **HAL库集成**: 基于STM32 HAL库开发，兼容GD32芯片
- **中断管理**: 统一的中断处理机制

### 2. 任务调度器 (scheduler)
```c
// 协作式任务调度器，支持多任务管理
typedef struct {
    void (*task_func)(void);
    uint32_t rate_ms;
    uint32_t last_run;
} task_t;
```

**特点**:
- 简单高效的任务调度
- 基于时间片的任务管理
- 支持不同周期的任务
- 易于添加新任务

### 3. 应用层模块

#### 3.1 LED控制 (led_app)
- 多LED状态管理
- 支持手动/自动控制模式
- WebSocket远程控制接口

#### 3.2 按键处理 (btn_app)
- 按键消抖处理
- 支持短按、长按、双击等事件
- 可配置的按键回调机制

#### 3.3 串口通信 (uart_app)
- 多串口管理
- 环形缓冲区实现
- 命令解析和处理

#### 3.4 ADC/DAC应用 (adc_app, dac_app)
- 模拟信号采集和输出
- 支持DMA传输
- 波形分析功能

#### 3.5 存储系统 (flash_app, sd_fatfs)
- Flash存储管理
- SD卡文件系统支持
- LittleFS文件系统集成

#### 3.6 显示系统 (oled_app, u8g2_port, wououi_app)
- OLED显示驱动
- U8G2图形库集成
- WouoUI用户界面框架
- 触摸屏支持

#### 3.7 网络通信 (4g_web)
- 4G模块通信
- WebSocket客户端实现
- 远程控制和数据传输

#### 3.8 Shell系统 (shell_app)
- 命令行界面
- 调试和系统控制
- 命令解析和执行

### 4. 工具库

#### 4.1 环形缓冲区 (ringbuffer)
- 高效的FIFO缓冲区实现
- 支持任意数据类型
- 线程安全操作

#### 4.2 按键库 (ebtn)
- 事件驱动按键处理
- 支持多种按键事件
- 可配置的按键参数

#### 4.3 波形分析 (waveform_analyzer_app)
- FFT傅里叶变换
- 频域分析功能
- 基于ARM DSP库

## 开发指南

### 1. 项目结构
```
CIMC_xi/
├── example/                 # 主项目目录
│   ├── APP/                # 应用层代码
│   │   ├── scheduler.c/h   # 任务调度器
│   │   ├── led_app.c/h     # LED控制
│   │   ├── uart_app.c/h    # 串口通信
│   │   ├── 4g_web.c/h      # 网络通信
│   │   └── ...             # 其他模块
│   ├── MDK-ARM/            # Keil项目文件
│   ├── Core/               # 核心系统代码
│   └── Drivers/            # 底层驱动
├── web/                    # Web前端和后端
│   ├── frontend/           # 前端界面
│   └── backend/            # 服务器代码
└── docs/                   # 文档目录
```

### 2. 添加新任务
```c
// 1. 在 scheduler.c ��添加任务
static task_t scheduler_task[] = {
    // ... 现有任务
    {your_task, 100, 0}  // 100ms周期的任务
};

// 2. 实现任务函数
void your_task(void) {
    // 任务逻辑
}
```

### 3. 添加新模块
```c
// 1. 创建模块头文件 (your_module.h)
#ifndef __YOUR_MODULE_H__
#define __YOUR_MODULE_H__

void your_module_init(void);
void your_module_task(void);

#endif

// 2. 创建模块源文件 (your_module.c)
#include "your_module.h"

void your_module_init(void) {
    // 初始化代码
}

void your_module_task(void) {
    // 任务执行代码
}
```

## 外设使用指南

### 1. LED控制
```c
#include "led_app.h"

// LED初始化
led_init();

// 设置LED状态
led_set(1, 1);  // LED1开启
led_set(1, 0);  // LED1关闭

// LED任务（在调度器中调用）
led_task();
```

### 2. 串口通信
```c
#include "uart_app.h"

// 发送数据
uart_send_string("Hello World\r\n");

// 接收数据处理
uart_task();
```

### 3. ADC采集
```c
#include "adc_app.h"

// ADC初始化
adc_init();

// 获取ADC值
uint16_t value = adc_get_value(1);  // 通道1
```

## STM32 HAL库集成

### 1. HAL库结构
```
Drivers/
├── STM32F4xx_HAL_Driver/    # STM32F4 HAL库
│   ├── Inc/                 # 头文件
│   └── Src/                 # 源文件
├── CMSIS/                   # CMSIS层
│   ├── Device/              # 设备相关
│   └── Include/             # CMSIS头文件
└── BSP/                     # 板级支持包
```

### 2. 主要HAL函数
```c
// 系统时钟配置
SystemClock_Config();

// GPIO操作
HAL_GPIO_WritePin(GPIOx, GPIO_Pin, PinState);
HAL_GPIO_ReadPin(GPIOx, GPIO_Pin);

// UART操作
HAL_UART_Transmit(&huart1, data, size, timeout);
HAL_UART_Receive(&huart1, data, size, timeout);

// ADC操作
HAL_ADC_Start(&hadc1);
HAL_ADC_GetValue(&hadc1);
```

## STM32F429芯片特性

### 1. 主要规格
- **内核**: ARM Cortex-M4 @ 180MHz
- **Flash**: 1MB
- **SRAM**: 256KB
- **外设**:
  - 3×ADC, 2×DAC
  - 17×TIM
  - 6×USART, 3×SPI, 3×I2C
  - SDIO, USB OTG
  - LCD-TFT控制器

### 2. 时钟系统
```
HSE (8MHz) → PLL → 180MHz (SYSCLK)
                ├── 90MHz (APB1 peripheral)
                ├── 180MHz (APB2 peripheral)
                └── 48MHz (USB/SDIO)
```

### 3. 内存映射
```
0x00000000: Flash Memory (1MB)
0x20000000: SRAM (256KB)
0x40000000: Peripherals
0xE0000000: Cortex-M4 PPB
```

## 最佳实践

### 1. 代码规范
- 使用驼峰命名法
- 函数名以模块名开头
- 变量名使用下划线分隔
- 每个模块包含头文件和源文件

### 2. 内存管理
- 优先使用静态分配
- 避免在中断中使用动态内存
- 使用环形缓冲区处理流数据

### 3. 中断处理
- 中断服务程序保持简短
- 使用标志位在主循环中处理复杂逻辑
- 避免在中断中调用耗时函数

### 4. 错误处理
- 使用统一的错误码定义
- 添加适当的错误检查
- 实现故障恢复机制

## 编译和调试

### 1. Keil MDK配置
```
Project Options -> Target:
  - Device: STM32F429IGT6
  - CPU Clock: 180MHz
  - Use MicroLIB: Enable

Project Options -> C/C++:
  - Optimization: -O2
  - Define: USE_HAL_DRIVER, STM32F429xx
```

### 2. 调试配置
- 使用ST-Link调试器
- 启用SWD接口
- 配置实时变量显示

### 3. 常见问题解决
- **硬故障**: 检查栈溢出和内存访问错误
- **时钟问题**: 确认PLL配置正确
- **外设不工作**: 检查时钟使能和引脚配置

## Web集成

### 1. WebSocket通信
```javascript
// 前端连接
const ws = new WebSocket('ws://localhost:47315');

// 发送命令
ws.send('LED1_ON');

// 接收消息
ws.onmessage = function(event) {
    console.log('收到消息:', event.data);
};
```

### 2. 服务器架构
- **后端**: Node.js WebSocket服务器
- **前端**: HTML/CSS/JavaScript
- **协议**: 简单字符串协议

## 扩展和定制

### 1. 添加新的通信协议
```c
// 在4g_web.c中添加协议处理
void parse_new_protocol(uint8_t *buffer, uint16_t length) {
    // 协议解析逻辑
}
```

### 2. 自定义UI组件
```c
// 在wououi_app.c中添加新组件
void custom_component_init(void) {
    // 组件初始化
}

void custom_component_draw(void) {
    // 组件绘制
}
```

## 性能优化

### 1. CPU使用率优化
- 合理安排任务优先级
- 使用DMA减少CPU负担
- 优化算法复杂度

### 2. 内存优化
- 使用合适的数据类型
- 及时释放不用的内存
- 优化编译器选项

### 3. 功耗优化
- 使用低功耗模式
- 动态调整时钟频率
- 关闭不用的外设

## 版本历史

- **v1.0**: 基础框架实现
- **v1.1**: 添加WebSocket支持
- **v1.2**: 集成WouoUI框架
- **v1.3**: 添加LittleFS支持
- **v1.4**: 完善调试系统

## 技术支持

本框架基于多年嵌入式开发经验积累，提供了完整的解决方案。如有问题，可以参考：
1. STM32 HAL库官方文档
2. STM32F429数据手册
3. 本框架源代码注释
4. 示例代码和测试用例

---

**注意**: 本框架适用于GD32和STM32F4系列芯片，具有良好的兼容性和可移植性。