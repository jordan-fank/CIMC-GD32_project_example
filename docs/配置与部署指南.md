# GD32é¡¹ç›®æ¡†æ¶é…ç½®ä¸éƒ¨ç½²æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä¸­é…ç½®å’Œéƒ¨ç½²GD32é¡¹ç›®æ¡†æ¶ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒã€å†…ç½‘ç©¿é€ç­‰å¤šç§åœºæ™¯ã€‚

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒé…ç½®

### 1. Keil MDK-ARMå®Œæ•´é…ç½®

#### 1.1 é¡¹ç›®è®¾ç½®
```
Project -> Options for Target -> Target:
  Device: STM32F429IGT6
  Use MicroLIB: âœ“
  Operating System: None
  Use Cross-Module Optimization: âœ“
```

#### 1.2 C/C++ç¼–è¯‘é€‰é¡¹
```
C/C++ -> Preprocessor Symbols:
  Define: USE_HAL_DRIVER, STM32F429xx

C/C++ -> Optimization:
  Level: -O2 (Optimize for time)
  One ELF Section per Function: âœ“
  Strict ANSI C: âœ“

C/C++ -> Include Paths:
  - ../Core/Inc
  - ../Drivers/STM32F4xx_HAL_Driver/Inc
  - ../Drivers/CMSIS/Device/ST/STM32F4xx/Include
  - ../Drivers/CMSIS/Include
  - ../APP
```

#### 1.3 è°ƒè¯•å™¨è®¾ç½®
```
Debug -> Use: ST-Link Debugger
Debug -> Settings -> Flash Download:
  Reset and Run: âœ“
  Programming Algorithm: STM32F4xx 1024KB Flash

Debug -> Settings -> Trace:
  Enable: âœ“ (å¦‚éœ€ETBè·Ÿè¸ª)
  Core Clock: 180MHz
```

### 2. å¤–è®¾é…ç½®è¯¦è§£

#### 2.1 æ—¶é’Ÿé…ç½® (RCC)
```c
// system_stm32f4xx.c ä¸­çš„æ—¶é’Ÿé…ç½®
void SystemClock_Config(void) {
    RCC_OscInitTypeDef RCC_OscInitStruct = {0};
    RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

    // é…ç½®ä¸»PLL
    RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
    RCC_OscInitStruct.HSEState = RCC_HSE_ON;
    RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
    RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
    RCC_OscInitStruct.PLL.PLLM = 8;
    RCC_OscInitStruct.PLL.PLLN = 360;
    RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
    RCC_OscInitStruct.PLL.PLLQ = 7;
    HAL_RCC_OscConfig(&RCC_OscInitStruct);

    // é…ç½®ç³»ç»Ÿæ—¶é’Ÿ
    RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                                |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
    RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
    RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
    RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
    RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;
    HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5);
}
```

#### 2.2 GPIOé…ç½®
```c
// LEDå¼•è„šé…ç½®
void MX_GPIO_Init(void) {
    GPIO_InitTypeDef GPIO_InitStruct = {0};

    __HAL_RCC_GPIOC_CLK_ENABLE();  // ä½¿èƒ½GPIOCæ—¶é’Ÿ

    // é…ç½®LEDå¼•è„š PC0-PC5
    GPIO_InitStruct.Pin = GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3|GPIO_PIN_4|GPIO_PIN_5;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);
}
```

#### 2.3 USARTé…ç½®
```c
// USART1 (è°ƒè¯•ä¸²å£) é…ç½®
void MX_USART1_UART_Init(void) {
    huart1.Instance = USART1;
    huart1.Init.BaudRate = 115200;
    huart1.Init.WordLength = UART_WORDLENGTH_8B;
    huart1.Init.StopBits = UART_STOPBITS_1;
    huart1.Init.Parity = UART_PARITY_NONE;
    huart1.Init.Mode = UART_MODE_TX_RX;
    huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
    huart1.Init.OverSampling = UART_OVERSAMPLING_16;
    HAL_UART_Init(&huart1);
}
```

## ğŸŒ WebæœåŠ¡å™¨éƒ¨ç½²

### 1. æœ¬åœ°å¼€å‘éƒ¨ç½²

#### 1.1 å®‰è£…Node.jsç¯å¢ƒ
```bash
# ä¸‹è½½å¹¶å®‰è£…Node.js (æ¨èv18+)
node --version
npm --version

# å®‰è£…é¡¹ç›®ä¾èµ–
cd web/backend
npm init -y
npm install ws express
```

#### 1.2 é…ç½®æœåŠ¡å™¨
```javascript
// websocket-server.js é…ç½®
const WebSocket = require('ws');

const WS_PORT = 47315;  // WebSocketç«¯å£
const HEARTBEAT_INTERVAL = 30000;  // å¿ƒè·³é—´éš”

const wss = new WebSocket.Server({
    port: WS_PORT,
    path: '/'
});
```

```javascript
// http-server.js é…ç½®
const express = require('express');
const path = require('path');
const HTTP_PORT = 8080;  // HTTPç«¯å£

const app = express();
app.use(express.static(path.join(__dirname, '../frontend')));
```

#### 1.3 å¯åŠ¨è„šæœ¬
```javascript
// start-all.js ç»Ÿä¸€å¯åŠ¨è„šæœ¬
const { spawn } = require('child_process');

// å¯åŠ¨WebSocketæœåŠ¡å™¨
const wsProcess = spawn('node', ['websocket-server.js'], {
    cwd: __dirname,
    stdio: 'inherit'
});

// å¯åŠ¨HTTPæœåŠ¡å™¨
const httpProcess = spawn('node', ['http-server.js'], {
    cwd: __dirname,
    stdio: 'inherit'
});
```

### 2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 2.1 PM2è¿›ç¨‹ç®¡ç†
```bash
# å®‰è£…PM2
npm install -g pm2

# åˆ›å»ºPM2é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'websocket-server',
    script: './websocket-server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '200M',
    env: {
      NODE_ENV: 'production'
    }
  }, {
    name: 'http-server',
    script: './http-server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '200M',
    env: {
      NODE_ENV: 'production'
    }
  }]
};
EOF

# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

#### 2.2 Nginxåå‘ä»£ç†
```nginx
# /etc/nginx/sites-available/gd32-framework
server {
    listen 80;
    server_name your-domain.com;

    # HTTPæœåŠ¡å™¨
    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocketä»£ç†
    location /ws {
        proxy_pass http://localhost:47315;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 2.3 SSL/HTTPSé…ç½®
```bash
# ä½¿ç”¨Let's Encryptè·å–SSLè¯ä¹¦
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com

# é…ç½®HTTPSé‡å®šå‘
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## ğŸŒ å†…ç½‘ç©¿é€éƒ¨ç½²

### 1. LoCyanFrpé…ç½®

#### 1.1 éš§é“é…ç½®
```
# HTTPéš§é“é…ç½®
éš§é“åç§°: gd32-web
éš§é“ç±»å‹: HTTP
æœ¬åœ°IP: 127.0.0.1
æœ¬åœ°ç«¯å£: 8080
åŸŸå: www.yanjin.xyz

# TCPéš§é“é…ç½® (WebSocket)
éš§é“åç§°: gd32-websocket
éš§é“ç±»å‹: TCP
æœ¬åœ°IP: 127.0.0.1
æœ¬åœ°ç«¯å£: 47315
è¿œç¨‹ç«¯å£: 47315 (éšæœºåˆ†é…)
```

#### 1.2 å®¢æˆ·ç«¯é…ç½®
```ini
# frpc.ini
[common]
server_addr = frp.lcf.im
server_port = 7000
token = your_token

[gd32-web-http]
type = http
local_ip = 127.0.0.1
local_port = 8080
custom_domains = www.yanjin.xyz

[gd32-web-tcp]
type = tcp
local_ip = 127.0.0.1
local_port = 47315
remote_port = 47315
```

### 2. 4Gæ¨¡å—é…ç½®

#### 2.1 æ¨¡å—è®¾ç½®
```c
// 4Gæ¨¡å—è¿æ¥é…ç½®
#define GSM_APN        "CMNET"
#define GSM_SERVER     "www.yanjin.xyz"
#define GSM_PORT       8080
#define GSM_WS_SERVER  "hk-4.lcf.im"
#define GSM_WS_PORT    47315
```

#### 2.2 è¿æ¥å»ºç«‹
```c
// å»ºç«‹WebSocketè¿æ¥
void gsm_websocket_connect(void) {
    char cmd[128];

    // 1. å»ºç«‹TCPè¿æ¥
    sprintf(cmd, "AT+CIPSTART=\"TCP\",\"%s\",%d", GSM_WS_SERVER, GSM_WS_PORT);
    gsm_send_command(cmd, "CONNECT", 5000);

    // 2. å‘é€WebSocketæ¡æ‰‹
    sprintf(cmd, "GET / HTTP/1.1\r\nHost: %s:%d\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\nSec-WebSocket-Version: 13\r\n\r\n",
            GSM_WS_SERVER, GSM_WS_PORT);
    gsm_send_data(cmd, strlen(cmd));
}
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 1. æ€§èƒ½ä¼˜åŒ–

#### 1.1 ç¼–è¯‘ä¼˜åŒ–
```c
// ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹
#pragma GCC optimize ("O2")
#pragma GCC optimize ("Os")  // ä¼˜åŒ–ä»£ç å¤§å°

// å…³é”®å‡½æ•°ä¼˜åŒ–
__attribute__((always_inline)) static inline void fast_function(void) {
    // å†…è”å‡½æ•°
}
```

#### 1.2 å†…å­˜ä¼˜åŒ–
```c
// å†…å­˜æ± ç®¡ç†
#define MEMORY_POOL_SIZE 1024
static uint8_t memory_pool[MEMORY_POOL_SIZE];
static uint16_t pool_index = 0;

void* pool_alloc(size_t size) {
    if (pool_index + size > MEMORY_POOL_SIZE) {
        return NULL;  // å†…å­˜ä¸è¶³
    }
    void* ptr = &memory_pool[pool_index];
    pool_index += size;
    return ptr;
}
```

#### 1.3 ä»»åŠ¡è°ƒåº¦ä¼˜åŒ–
```c
// ä¼˜åŒ–ä»»åŠ¡æ‰§è¡Œå‘¨æœŸ
static task_t scheduler_task[] = {
    {led_task,      10,   0},   // 10ms - LEDå¿«é€Ÿå“åº”
    {btn_task,      5,    0},   // 5ms  - æŒ‰é”®åŠæ—¶æ£€æµ‹
    {uart_task,     5,    0},   // 5ms  - ä¸²å£åŠæ—¶å¤„ç†
    {adc_task,      100,  0},   // 100ms - ADCé€‚ä¸­é‡‡æ ·
    {oled_task,     50,   0},   // 50ms  - æ˜¾ç¤ºåˆ·æ–°
    {websocket_task,20,   0},   // 20ms  - ç½‘ç»œåŠæ—¶å¤„ç†
};
```

### 2. å¯é æ€§ä¼˜åŒ–

#### 2.1 çœ‹é—¨ç‹—é…ç½®
```c
// ç‹¬ç«‹çœ‹é—¨ç‹—é…ç½®
void iwdg_init(void) {
    hiwdg.Instance = IWDG;
    hiwdg.Init.Prescaler = IWDG_PRESCALER_32;
    hiwdg.Init.Reload = 4095;  // çº¦1.3ç§’è¶…æ—¶
    HAL_IWDG_Init(&hiwdg);
}

// åœ¨ä¸»å¾ªç¯ä¸­å–‚ç‹—
void iwdg_refresh(void) {
    HAL_IWDG_Refresh(&hiwdg);
}
```

#### 2.2 é”™è¯¯å¤„ç†
```c
// ç»Ÿä¸€é”™è¯¯å¤„ç†
typedef enum {
    ERROR_NONE = 0,
    ERROR_HARDWARE,
    ERROR_NETWORK,
    ERROR_MEMORY,
    ERROR_PROTOCOL
} error_code_t;

void error_handler(error_code_t error_code) {
    switch (error_code) {
        case ERROR_HARDWARE:
            log_error("Hardware error detected");
            // ç¡¬ä»¶é”™è¯¯å¤„ç†
            break;
        case ERROR_NETWORK:
            log_error("Network connection lost");
            // ç½‘ç»œé‡è¿é€»è¾‘
            break;
        default:
            log_error("Unknown error");
            break;
    }
}
```

### 3. å®‰å…¨æ€§é…ç½®

#### 3.1 WebSocketå®‰å…¨
```javascript
// WebSocketè®¤è¯
wss.on('connection', (ws, req) => {
    const token = req.headers['authorization'];
    if (!validate_token(token)) {
        ws.close(1008, 'Invalid token');
        return;
    }

    // è¿æ¥æˆåŠŸï¼Œæ³¨å†Œå®¢æˆ·ç«¯
    register_client(ws);
});
```

#### 3.2 æ•°æ®åŠ å¯†
```c
// ç®€å•çš„æ•°æ®åŠ å¯†
void simple_encrypt(uint8_t *data, uint16_t len, uint8_t key) {
    for (uint16_t i = 0; i < len; i++) {
        data[i] ^= key;
    }
}

void simple_decrypt(uint8_t *data, uint16_t len, uint8_t key) {
    simple_encrypt(data, len, key);  // å¼‚æˆ–åŠ å¯†ï¼Œè§£å¯†ç›¸åŒ
}
```

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### 1. ç³»ç»Ÿç›‘æ§

#### 1.1 æ€§èƒ½ç›‘æ§
```c
// CPUä½¿ç”¨ç‡ç›‘æ§
uint32_t cpu_usage_monitor(void) {
    static uint32_t idle_count = 0;
    static uint32_t total_count = 0;

    total_count++;
    if (system_state == IDLE) {
        idle_count++;
    }

    if (total_count % 1000 == 0) {
        uint32_t usage = 100 - (idle_count * 100 / total_count);
        printf("CPU Usage: %lu%%\r\n", usage);
        idle_count = total_count = 0;
    }
}
```

#### 1.2 å†…å­˜ç›‘æ§
```c
// å†…å­˜ä½¿ç”¨ç›‘æ§
void memory_monitor(void) {
    extern uint32_t _heap_start, _heap_end, _stack_start;

    uint32_t heap_size = (uint32_t)&_heap_end - (uint32_t)&_heap_start;
    uint32_t stack_used = (uint32_t)&_stack_start - (uint32_t)get_stack_pointer();

    printf("Heap: %lu bytes\r\n", heap_size);
    printf("Stack used: %lu bytes\r\n", stack_used);
}
```

### 2. æ—¥å¿—ç³»ç»Ÿ

#### 2.1 æœ¬åœ°æ—¥å¿—
```c
// Flashæ—¥å¿—è®°å½•
#define LOG_SECTOR    10  // ä½¿ç”¨ç¬¬10æ‰‡åŒºå­˜å‚¨æ—¥å¿—

typedef struct {
    uint32_t timestamp;
    uint8_t level;
    char message[64];
} log_entry_t;

void write_log(uint8_t level, const char *message) {
    log_entry_t entry;
    entry.timestamp = HAL_GetTick();
    entry.level = level;
    strncpy(entry.message, message, sizeof(entry.message) - 1);

    flash_write_log_entry(&entry);
}
```

#### 2.2 è¿œç¨‹æ—¥å¿—
```c
// é€šè¿‡WebSocketå‘é€æ—¥å¿—
void send_log_to_server(const char *log_data) {
    if (websocket_connected) {
        char log_msg[256];
        sprintf(log_msg, "LOG:%s", log_data);
        websocket_send_string(log_msg);
    }
}
```

## ğŸ”„ è‡ªåŠ¨åŒ–éƒ¨ç½²

### 1. è„šæœ¬åŒ–éƒ¨ç½²

#### 1.1 ä¸€é”®éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy.sh

echo "å¼€å§‹éƒ¨ç½²GD32é¡¹ç›®æ¡†æ¶..."

# 1. æ›´æ–°ä»£ç 
git pull origin main

# 2. ç¼–è¯‘é¡¹ç›®
cd example/MDK-ARM
uvprojx_build test2.uvprojx -j0

# 3. å¯åŠ¨æœåŠ¡å™¨
cd ../../web/backend
pm2 restart ecosystem.config.js

echo "éƒ¨ç½²å®Œæˆï¼"
```

#### 1.2 Windowsæ‰¹å¤„ç†è„šæœ¬
```batch
@echo off
echo Starting GD32 Framework Deployment...

cd /d %~dp0\web\backend
call npm install
start /B pm2 start ecosystem.config.js

echo Deployment completed!
echo Web interface: http://localhost:8080
echo WebSocket: ws://localhost:47315
pause
```

### 2. CI/CDé›†æˆ

#### 2.1 GitHub Actions
```yaml
# .github/workflows/deploy.yml
name: Deploy GD32 Framework

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        cd web/backend
        npm install

    - name: Deploy to production
      run: |
        # éƒ¨ç½²è„šæœ¬
        echo "Deploying to production..."
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ä»£ç ç¼–è¯‘æ— é”™è¯¯
- [ ] ç¡¬ä»¶è¿æ¥æ­£å¸¸
- [ ] ç½‘ç»œç¯å¢ƒé…ç½®
- [ ] ä¾èµ–åŒ…å®‰è£…å®Œæ•´
- [ ] é…ç½®æ–‡ä»¶å‚æ•°ç¡®è®¤

### éƒ¨ç½²ä¸­æ£€æŸ¥
- [ ] æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] ç«¯å£ç›‘å¬æ­£ç¡®
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸
- [ ] èµ„æºä½¿ç”¨åˆç†

### éƒ¨ç½²åæ£€æŸ¥
- [ ] Webç•Œé¢è®¿é—®æ­£å¸¸
- [ ] WebSocketè¿æ¥æ­£å¸¸
- [ ] è®¾å¤‡åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- [ ] é”™è¯¯æ—¥å¿—æ£€æŸ¥

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§éƒ¨ç½²é—®é¢˜

1. **ç«¯å£è¢«å ç”¨**
   ```bash
   # æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
   netstat -ano | findstr :8080
   # ç»“æŸè¿›ç¨‹
   taskkill /PID <è¿›ç¨‹ID> /F
   ```

2. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ—¥å¿—
   pm2 logs
   # é‡å¯æœåŠ¡
   pm2 restart all
   ```

3. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   sudo ufw status
   # å¼€æ”¾ç«¯å£
   sudo ufw allow 8080
   sudo ufw allow 47315
   ```

---

**æ€»ç»“**: æœ¬é…ç½®æŒ‡å—æ¶µç›–äº†ä»å¼€å‘ç¯å¢ƒåˆ°ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´éƒ¨ç½²æµç¨‹ã€‚æŒ‰ç…§æœ¬æŒ‡å—æ“ä½œï¼Œå¯ä»¥ç¡®ä¿GD32é¡¹ç›®æ¡†æ¶åœ¨å„ç§ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œã€‚

**è®°ä½**: å®šæœŸå¤‡ä»½æ•°æ®ï¼Œç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼ŒåŠæ—¶æ›´æ–°é…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨ç¨³å®šè¿è¡Œã€‚