# 内网穿透配置完整指南 - 实现域名访问

## 📌 当前状态诊断

### ✅ 已完成的部分
- [x] 服务器已正确运行在端口 8080
- [x] HTTP 和 WebSocket 服务已合并到同一端口
- [x] 前端页面可以通过 `http://localhost:8080` 本地访问
- [x] 4G模块可以连接到 `ws://www.yanjin.xyz` (说明WebSocket穿透已配置)

### ❌ 需要解决的问题
- [ ] 浏览器访问 `http://www.yanjin.xyz` 时无法加载网页

---

## 🔍 问题诊断

### 原因分析

你的4G模块能连接 `ws://www.yanjin.xyz`,说明:
1. ✅ 域名解析正常
2. ✅ 内网穿透的 **WebSocket通道** 已经工作
3. ❌ 但 **HTTP通道** 可能没有正确配置

### 关键区别

- **WebSocket连接**: `ws://www.yanjin.xyz` → 可能映射到特定的WebSocket端口
- **HTTP访问**: `http://www.yanjin.xyz` → 需要映射到HTTP端口(通常是80或8080)

---

## 🛠️ 解决方案(根据不同的内网穿透工具)

### 方案一: FRP (Fast Reverse Proxy)

如果你使用的是 **frp**,需要配置 `frpc.ini`:

```ini
[common]
server_addr = 你的FRP服务器地址
server_port = 7000

# HTTP服务配置
[web-http]
type = http
local_port = 8080
custom_domains = www.yanjin.xyz

# 如果需要HTTPS
[web-https]
type = https
local_port = 8080
custom_domains = www.yanjin.xyz
```

**注意**:
- `type = http` 是关键,不能用 `tcp`
- FRP的HTTP模式会自动处理域名路由
- 确保FRP服务器的80端口(HTTP)和443端口(HTTPS)已开放

### 方案二: ngrok

如果使用 **ngrok**:

```bash
ngrok http 8080 --domain=www.yanjin.xyz
```

或者配置文件 `ngrok.yml`:

```yaml
version: "2"
authtoken: 你的authtoken
tunnels:
  web:
    proto: http
    addr: 8080
    hostname: www.yanjin.xyz
```

启动:
```bash
ngrok start web
```

### 方案三: 花生壳

如果使用 **花生壳**:

1. 登录花生壳客户端
2. 添加映射:
   - 应用名称: `智能终端管理系统`
   - 映射类型: **HTTP** (不是TCP!)
   - 内网主机: `127.0.0.1`
   - 内网端口: `8080`
   - 外网域名: `www.yanjin.xyz`

### 方案四: cpolar

如果使用 **cpolar**:

```bash
cpolar http 8080 -region cn -subdomain www.yanjin.xyz
```

或通过Web管理界面配置:
- 隧道协议: HTTP
- 本地地址: `8080`
- 域名: `www.yanjin.xyz`

---

## 🔧 通用排查步骤

### 步骤1: 确认本地服务器运行正常

```bash
# 检查服务器是否运行
netstat -ano | grep ":8080"

# 本地浏览器测试
# 打开: http://localhost:8080
```

**预期结果**: 能看到完整的前端界面

### 步骤2: 确认内网穿透连接状态

**FRP用户**:
```bash
# 查看frpc日志
tail -f frpc.log
# 应该看到 "start proxy success" 字样
```

**ngrok用户**:
```bash
# 查看ngrok终端输出
# 应该显示 "Forwarding http://www.yanjin.xyz -> http://localhost:8080"
```

### 步骤3: 测试内网穿透是否工作

**从外网测试** (使用手机4G网络或另一台电脑):

```bash
# 方法1: 使用curl测试
curl -I http://www.yanjin.xyz

# 预期输出:
# HTTP/1.1 200 OK
# Content-Type: text/html; charset=utf-8

# 方法2: 使用ping测试域名解析
ping www.yanjin.xyz
```

### 步骤4: 检查防火墙设置

**Windows防火墙**:

```powershell
# 以管理员权限运行PowerShell
# 添加防火墙规则允许Node.js
netsh advfirewall firewall add rule name="Node.js Server" dir=in action=allow program="C:\Program Files\nodejs\node.exe" enable=yes
```

**或者临时关闭防火墙测试**:
```powershell
# 临时关闭防火墙(仅用于测试)
netsh advfirewall set allprofiles state off

# 测试完成后记得重新开启
netsh advfirewall set allprofiles state on
```

---

## 📋 完整配置检查清单

请按顺序检查以下每一项:

### ✅ 服务器端检查

- [ ] 服务器正在运行: `node server.js`
- [ ] 端口8080被正确监听: `netstat -ano | grep 8080`
- [ ] 本地可以访问: `http://localhost:8080` 能打开网页
- [ ] 防火墙允许Node.js通信

### ✅ 内网穿透检查

- [ ] 内网穿透工具已启动
- [ ] 配置类型为 **HTTP** (不是TCP)
- [ ] 本地端口配置为 `8080`
- [ ] 域名配置为 `www.yanjin.xyz`
- [ ] 内网穿透日志显示连接成功

### ✅ 域名解析检查

- [ ] 域名已正确解析到内网穿透服务器
- [ ] 使用 `ping www.yanjin.xyz` 能得到响应
- [ ] DNS缓存已清除: `ipconfig /flushdns`

### ✅ 网络访问检查

- [ ] 从外网(4G网络)能访问域名
- [ ] 浏览器能正确加载HTML页面
- [ ] 浏览器控制台无错误(F12查看)

---

## 🚨 常见问题解决

### 问题1: 域名能ping通,但浏览器打不开

**原因**: 内网穿透配置为TCP模式,而不是HTTP模式

**解决**:
1. 修改内网穿透配置,将 `type = tcp` 改为 `type = http`
2. 重启内网穿透服务
3. 清除浏览器缓存: `Ctrl + Shift + Delete`

### 问题2: 浏览器显示"无法访问此网站"

**原因**: 域名未正确解析或内网穿透未启动

**解决**:
1. 检查域名DNS解析: `nslookup www.yanjin.xyz`
2. 确认内网穿透服务正在运行
3. 查看内网穿透日志是否有错误

### 问题3: 页面能打开,但WebSocket连接失败

**原因**: 前端自动检测的端口号不正确

**解决**:
检查前端自动填充的端口号是否与内网穿透实际映射的端口一致:

```javascript
// 在浏览器控制台(F12)运行:
console.log('当前域名:', window.location.hostname);
console.log('当前端口:', window.location.port);
```

如果端口号错误,手动修改连接配置。

### 问题4: 只有WebSocket能工作,HTTP不能访问

**原因**: 内网穿透配置了两个不同的映射(一个TCP给WebSocket,一个HTTP给网页)

**解决**:
使用统一配置,只保留一个HTTP类型的映射:

**FRP配置示例**:
```ini
[web]
type = http  # ← 关键:使用http类型
local_port = 8080
custom_domains = www.yanjin.xyz
```

HTTP协议本身支持WebSocket升级,所以单个HTTP映射可以同时处理网页访问和WebSocket连接。

---

## 🎯 推荐配置(最简单)

如果你想要最简单的配置,推荐使用 **FRP的HTTP模式**:

### FRP服务器配置 (frps.ini)

```ini
[common]
bind_port = 7000
vhost_http_port = 80  # HTTP端口
```

### FRP客户端配置 (frpc.ini)

```ini
[common]
server_addr = 你的公网服务器IP
server_port = 7000

[web]
type = http
local_ip = 127.0.0.1
local_port = 8080
custom_domains = www.yanjin.xyz
```

### 启动命令

```bash
# 服务器端(有公网IP的服务器)
./frps -c frps.ini

# 客户端(你的电脑)
./frpc -c frpc.ini
```

---

## 📞 需要你提供的信息

为了给出更精确的解决方案,请告诉我:

1. **你使用的内网穿透工具是什么?**
   - [ ] FRP
   - [ ] ngrok
   - [ ] 花生壳
   - [ ] cpolar
   - [ ] 其他: ___________

2. **当前的内网穿透配置文件内容** (如 frpc.ini, ngrok.yml 等)

3. **执行以下测试命令的结果**:
   ```bash
   # 测试1: 本地访问
   curl -I http://localhost:8080

   # 测试2: 域名解析
   nslookup www.yanjin.xyz

   # 测试3: 外网访问(用手机4G)
   curl -I http://www.yanjin.xyz
   ```

4. **内网穿透工具的日志输出** (最后20行)

---

## 🎓 工作原理说明

### 为什么4G模块能连接,但浏览器不能访问?

```
┌─────────────────────────────────────────────────────────────┐
│                      内网穿透服务器                          │
│                                                              │
│  端口80 (HTTP)  ──→  [未配置] ──✗→ 你的服务器8080          │
│                                                              │
│  端口XXX (TCP)  ──→  [已配置] ──✓→ 你的服务器8080          │
│                      (WebSocket专用)                         │
└─────────────────────────────────────────────────────────────┘
```

**解决方法**: 配置HTTP映射,让HTTP和WebSocket都能通过同一个通道:

```
┌─────────────────────────────────────────────────────────────┐
│                      内网穿透服务器                          │
│                                                              │
│  端口80 (HTTP)  ──→  [HTTP模式] ──✓→ 你的服务器8080        │
│                      支持WebSocket升级                       │
└─────────────────────────────────────────────────────────────┘
```

---

**下一步**: 请提供你的内网穿透配置信息,我将给出具体的修改方案!
