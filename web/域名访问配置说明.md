# 域名访问配置说明

## ✅ 已完成的修改

现在**HTTP服务和WebSocket服务已经合并到同一个端口（8080）**，这样你只需要一个内网穿透映射即可。

---

## 🎯 工作原理

```
用户访问                    内网穿透                   你的服务器
┌──────────────┐          ┌──────────┐              ┌────────────────┐
│              │          │          │              │                │
│ 浏览器访问:   │   HTTP   │  内网穿透 │   转发到     │  Node.js服务器  │
│ http://      │  ───────>│  服务     │   ───────>  │  端口 8080     │
│ www.yanjin   │          │          │              │                │
│ .xyz         │          │          │              │  - HTTP静态文件 │
│              │          │          │              │  - WebSocket   │
│              │  WebSocket│         │              │                │
│ ws://        │  ───────>│          │   ───────>  │  同一个端口!    │
│ www.yanjin   │          │          │              │                │
│ .xyz         │          │          │              │                │
└──────────────┘          └──────────┘              └────────────────┘
```

---

## 📋 配置步骤

### 1. 内网穿透配置

确保你的内网穿透工具（如 frp、ngrok、花生壳等）配置为：

```ini
[web]
type = tcp
local_port = 8080
remote_port = 80  # 或者你分配的端口
custom_domains = www.yanjin.xyz
```

**关键点**：
- ✅ 只需要映射 **一个端口 (8080)**
- ✅ HTTP 和 WebSocket 都走这个端口
- ✅ 域名指向这个端口

---

### 2. 启动服务器

```bash
cd C:\Users\HP\Desktop\CIMC_xi\web\backend

# 方式一：只启动WebSocket服务器（现在包含HTTP服务）
node server.js

# 方式二：使用npm脚本
npm run ws
```

你会看到：

```
===========================================
  智能终端管理系统 - 统一服务器
===========================================
  访问地址: http://localhost:8080
  WebSocket: ws://localhost:8080
  前端目录: c:\Users\HP\Desktop\CIMC_xi\web\backend\..\frontend
  心跳间隔: 30秒
===========================================

提示: 现在HTTP和WebSocket服务在同一端口！
```

---

### 3. 测试访问

#### **本地测试**

浏览器打开：
```
http://localhost:8080
```

你会看到完整的前端界面。

#### **公网访问**

浏览器打开：
```
http://www.yanjin.xyz
```

**自动行为**：
1. ✅ 页面会自动加载
2. ✅ WebSocket会自动填充为 `www.yanjin.xyz:80`（或你的映射端口）
3. ✅ 点击"连接服务器"即可连接

---

## 🔧 自动配置功能

前端新增了**自动检测功能**：

```javascript
// 当用户首次访问时
if (window.location.hostname === 'www.yanjin.xyz') {
    // 自动填充：
    服务器地址: www.yanjin.xyz
    端口: 80 (或实际映射的端口)
}
```

这意味着：
- ✅ 用户从域名访问时，无需手动配置
- ✅ 自动使用当前访问的域名
- ✅ 配置会保存到本地存储

---

## 🧪 完整测试流程

### **步骤1：启动服务器**

```bash
cd web/backend
node server.js
```

### **步骤2：本地测试**

浏览器打开 `http://localhost:8080`，应该能看到前端页面。

### **步骤3：4G模块测试**

你的4G模块连接：
```
ws://www.yanjin.xyz/
```

发送心跳包：`"websocket ok..."`

### **步骤4：浏览器公网测试**

浏览器打开：
```
http://www.yanjin.xyz
```

- 页面应该正常显示
- 服务器地址自动填充为 `www.yanjin.xyz`
- 点击"连接服务器"

### **步骤5：双向通信测试**

1. 浏览器发送消息 → 4G模块应该收到
2. 4G模块发送数据 → 浏览器应该显示

---

## 📌 重要提示

### ⚠️ 端口映射说明

如果你的内网穿透不是映射到80端口，而是其他端口（如8080），需要在访问时加上端口号：

```
http://www.yanjin.xyz:8080
ws://www.yanjin.xyz:8080
```

### ⚠️ HTTP vs HTTPS

如果你的域名启用了HTTPS：

1. WebSocket需要使用 `wss://` 而不是 `ws://`
2. 需要配置SSL证书
3. 修改前端代码中的协议检测逻辑

---

## 🔍 故障排查

### 问题1：浏览器能访问，但WebSocket连接失败

**检查项**：
- ✅ 确认服务器已启动（`node server.js`）
- ✅ 检查浏览器控制台是否有报错（F12）
- ✅ 确认填写的端口号正确

### 问题2：4G模块能连接，但浏览器看不到前端页面

**检查项**：
- ✅ 确认`frontend`目录存在且有`index.html`
- ✅ 查看服务器控制台的日志
- ✅ 尝试访问 `http://www.yanjin.xyz/index.html`

### 问题3：页面显示404

**检查项**：
- ✅ 确认启动的是 `server.js` 而不是 `http-server.js`
- ✅ 检查 `FRONTEND_DIR` 路径是否正确
- ✅ 查看服务器控制台的错误日志

---

## 📊 文件结构说明

```
web/
├── backend/
│   ├── server.js          # ✅ 使用这个（HTTP + WebSocket）
│   ├── http-server.js     # ❌ 不再需要单独启动
│   └── start-all.js       # ❌ 不再需要（已合并）
│
└── frontend/
    ├── index.html         # 前端页面
    ├── css/style.css      # 样式
    └── js/app.js          # 业务逻辑（含自动检测）
```

---

## 🎉 总结

现在你只需要：

1. **启动一个服务**: `node server.js`
2. **映射一个端口**: 8080 → 内网穿透
3. **访问一个地址**: `http://www.yanjin.xyz`

所有功能（HTTP + WebSocket）都在同一个端口工作！

---

**如有问题，查看服务器控制台日志，所有HTTP请求和WebSocket连接都会有详细记录。**
